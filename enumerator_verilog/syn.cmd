#!/bin/csh -f
# Ameer  Abdelhadi
# ameer@ece.ubc.ca
# May, 2011

# setup environment and run logic synthesis

# define variables
setenv TSMC65NM /CMC/kits/tsmc_65nm_libs/tcbn65lp/TSMCHOME/digital/
setenv LIBNAME  tcbn65lpwc
setenv LIBDB    $TSMC65NM/Front_End/timing_power_noise/NLDM/tcbn65lp_200a/
setenv TOPMOD   ${argv[1]}
setenv RUNNUM   ${argv[2]}
setenv SYNLIB   $PWD
setenv RTLLIB   ./rtl
setenv REPLIB   ./rep
setenv LOGLIB   ./log
setenv STALIB   ./sta
setenv NETLIB   ./net

set analyzeCommand = "analyze -format verilog -lib ${TOPMOD}_lib"

# setup cad tools
source ./setup.csh

# clean previous run outputs and directories
# /bin/rm -rf $REPLIB $LOGLIB $STALIB $NETLIB "./dwsvf_*" "./alib-*" "./*_lib"

# make output directories
mkdir       $REPLIB $LOGLIB $STALIB $NETLIB

# generate analyze_includes.dctcl to analyze included verilogs
printf "# Analyze included Verilog files...\n# Generated by syn.cmd\n\n" >! analyze_includes.dctcl
grep -E '^\s*`include\s*\"[^\"]*\.v\"' *.v | cut -d\" -f2 | sort | uniq | \
  perl -ne 'print " ./$_";' | sed "s/^/  $analyzeCommand/" >> analyze_includes.dctcl

# create hierarchies file
vhier.pl $TOPMOD >! hierarchies.lst

# generate analyze_modules.dctcl to analyze module verilog files
printf "# Analyze module Verilog files...\n# Generated by syn.cmd\n\n" >! analyze_modules.dctcl
perl -Xne '/^(\s*).*\@\s*(.*)/; if ($2) {if ($seen{$2}++) {print "# "} else {print "  "}; \
           print "@ARGV $1$2\n";}' hierarchies.lst "$analyzeCommand" >> analyze_modules.dctcl

# run dc_shell-t with syn.dctcl
dc_shell-t -f ./syn.dctcl | tee $LOGLIB/syn.$RUNNUM.log
